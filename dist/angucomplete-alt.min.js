/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";angular.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache",function(e,t,n,r,i,s){var o=40;var u=39;var a=38;var f=37;var l=27;var c=13;var h=8;var p=46;var d=9;var v=3;var m=500;var g=200;var y="autocomplete-required";var b="Searching...";var w="No results found";var E="/angucomplete-alt/index.html";s.put(E,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">'+'  <input id="{{id}}_value" ng-model="searchStr" ng-disabled="disableInput" type="text" placeholder="{{placeholder}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>'+'  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">'+'    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>'+'    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>'+'    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">'+'      <div ng-if="imageField" class="angucomplete-image-holder">'+'        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>'+'        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>'+"      </div>"+'      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>'+'      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>'+'      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>'+'      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>'+"    </div>"+"  </div>"+"</div>");return{restrict:"EA",require:"^?form",scope:{selectedObject:"=",moreResults:"=",disableInput:"=",initialValue:"@",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",id:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&"},templateUrl:function(e,t){return t.templateUrl||E},link:function(t,s,h,p){function P(e){return e.which?e.which:e.keyCode}function H(e){if(typeof t.selectedObject==="function"){t.selectedObject(e)}else{t.selectedObject=e}if(e){R(true)}else{R(false)}}function B(e){return function(n){return t[e]?t[e](n):n}}function j(e){H({originalObject:e});if(t.clearSelected){t.searchStr=null}tt()}function F(e){return t.titleField.split(",").map(function(t){return I(e,t)}).join(" ")}function I(e,t){var n,r;if(t){n=t.split(".");r=e;n.forEach(function(e){r=r[e]})}else{r=e}return r}function q(e,n){var i,s,o=new RegExp(n,"i");if(!e){return}s=e.match(o);if(s){i=e.replace(o,'<span class="'+t.matchClass+'">'+s[0]+"</span>")}else{i=e}return r.trustAsHtml(i)}function R(e){k=t.searchStr;if(t.fieldRequired&&p){p.$setValidity(N,e)}}function U(e){var n=P(e);if(n===f||n===u){return}if(n===a||n===c){e.preventDefault()}else if(n===o){e.preventDefault();if(!t.showDropdown&&t.searchStr&&t.searchStr.length>=S){nt();t.searching=true;st(t.searchStr)}}else if(n===l){tt();t.$apply(function(){E.val(t.searchStr)})}else{if(!t.searchStr||t.searchStr===""){t.showDropdown=false}else if(t.searchStr.length>=S){nt();if(x){i.cancel(x)}t.searching=true;x=i(function(){st(t.searchStr)},t.pause)}if(k&&k!==t.searchStr&&!t.clearSelected){H(undefined)}}}function z(e){if(t.overrideSuggestions&&!(t.selectedObject&&t.selectedObject.originalObject===t.searchStr)){if(e){e.preventDefault()}j(t.searchStr)}}function W(e){var t=getComputedStyle(e);return e.offsetHeight+parseInt(t.marginTop,10)+parseInt(t.marginBottom,10)}function X(){return A.getBoundingClientRect().top+parseInt(getComputedStyle(A).maxHeight,10)}function V(){return s[0].querySelectorAll(".angucomplete-row")[t.currentIndex]}function $(){return V().getBoundingClientRect().top-(A.getBoundingClientRect().top+parseInt(getComputedStyle(A).paddingTop,10))}function J(e){A.scrollTop=A.scrollTop+e}function K(){var e=t.results[t.currentIndex];if(t.matchClass){E.val(F(e.originalObject))}else{E.val(e.title)}}function Q(e){var n=P(e);var r=null;var i=null;if(n===c&&t.results){if(t.currentIndex>=0&&t.currentIndex<t.results.length){e.preventDefault();t.selectResult(t.results[t.currentIndex])}else{z(e);tt()}t.$apply()}else if(n===o&&t.results){e.preventDefault();if(t.currentIndex+1<t.results.length&&t.showDropdown){t.$apply(function(){if(!ut(t.results[t.currentIndex+1])){while(t.currentIndex+1<t.results.length&&!ut(t.results[t.currentIndex+1])){t.currentIndex++}}t.currentIndex++;if(ut(t.results[t.currentIndex])){K()}});if(O){r=V();if(X()<r.getBoundingClientRect().bottom){J(W(r))}}}}else if(n===a&&t.results){e.preventDefault();if(t.currentIndex>=1){t.$apply(function(){if(!ut(t.results[t.currentIndex-1])){while(t.currentIndex>=1&&!ut(t.results[t.currentIndex-1])){t.currentIndex--}}t.currentIndex--;if(ut(t.results[t.currentIndex])){K()}});if(O){i=$();if(i<0){J(i-1)}}}else if(t.currentIndex===0){t.$apply(function(){t.currentIndex=-1;E.val(t.searchStr)})}}else if(n===d){if(t.results&&t.results.length>0&&t.showDropdown){if(t.currentIndex===-1&&t.overrideSuggestions){z()}else{if(t.currentIndex===-1){t.currentIndex=0}t.selectResult(t.results[t.currentIndex]);t.$digest()}}else{if(t.searchStr&&t.searchStr.length>0){z()}}}}function G(e){return function(n,r,i,s){t.searching=false;lt(I(C(n),t.remoteUrlDataField),e)}}function Y(e,n,r,i){if(n!==0){if(t.remoteUrlErrorCallback){t.remoteUrlErrorCallback(e,n,r,i)}else{if(console&&console.error){console.error("http error")}}}}function Z(){if(L){L.resolve()}}function et(r){var i={},s=t.remoteUrl+r;if(t.remoteUrlRequestFormatter){i={params:t.remoteUrlRequestFormatter(r)};s=t.remoteUrl}Z();L=e.defer();i.timeout=L.promise;n.get(s,i).success(G(r)).error(Y)}function tt(){t.showDropdown=false;t.results=[];if(A){A.scrollTop=0}}function nt(){t.showDropdown=true;t.currentIndex=-1;t.results=[]}function rt(e){var n,r,i,s,o=t.searchFields.split(","),u=[];for(n=0;n<t.localData.length;n++){r=false;for(i=0;i<o.length;i++){s=I(t.localData[n],o[i])||"";r=r||s.toLowerCase().indexOf(e.toLowerCase())>=0}if(r){u[u.length]=t.localData[n]}}t.searching=false;lt(u,e)}function it(e,n,r){for(var i in n){if(n[i].toLowerCase()===r.toLowerCase()){t.selectResult(e);return}}}function st(e){if(e.length<S){return}if(t.localData){t.$apply(function(){rt(e)})}else{et(e)}}function ft(e,n,r){var i,s,o,u,a;if(t.titleField&&t.titleField!==""){o=u=F(e)}i="";if(t.descriptionField){i=a=I(e,t.descriptionField)}s="";if(t.imageField){s=I(e,t.imageField)}if(t.matchClass){u=q(o,n);a=q(i,n)}t.results[t.results.length]={title:u,description:a,image:s,originalObject:e};if(r){t.results[t.results.length-1].group_title=r}if(t.autoMatch){it(t.results[t.results.length-1],{title:o,desc:i||""},t.searchStr)}}function lt(e,n){var r,i,s,o,u;t.results=[];if(e){if(ot(e)&&e.length>0){for(r=0,s=e.length;r<s;r++){ft(e[r],n)}}else if(ut(e)){u=at(e);for(var r=0,s=u.length;r<s;r++){o=e[u[r]].length;if(o>0){t.results[t.results.length]=u[r];for(i=0;i<o;i++){ft(e[u[r]][i],n,u[r])}}}}}}var E=s.find("input");var S=v;var x=null;var T;var N=y;var C;var k=null;var L=null;var A=s[0].querySelector(".angucomplete-dropdown");var O=false;var M=null;var D;s.on("mousedown",function(e){M=e.target.id});t.currentIndex=null;t.searching=false;t.searchStr=t.initialValue;D=t.$watch("initialValue",function(e,n){if(e&&e.length>0){t.searchStr=t.initialValue;R(true);D()}});t.$on("angucomplete-alt:clearInput",function(e,n){if(!n){t.searchStr=null;tt()}else{if(t.id===n){t.searchStr=null;tt()}}});var ot=Array.isArray||function(e){return toString.call(e)==="[object Array]"};var ut=function(e){var t=typeof e;return t==="function"||t==="object"&&!!e};var at=function(e){if(!ut(e))return[];if(Object.keys)return Object.keys(e);var t=[];for(var n in e)if(_.has(e,n))t.push(n);return t};t.onFocusHandler=function(){if(t.focusIn){t.focusIn()}};t.hideResults=function(e){if(M===t.id+"_dropdown"){M=null}else{T=i(function(){tt();t.$apply(function(){if(t.searchStr&&t.searchStr.length>0){E.val(t.searchStr)}})},g);Z();if(t.focusOut){t.focusOut()}}};t.resetHideResults=function(){if(T){i.cancel(T)}};t.hoverRow=function(e){t.currentIndex=e};t.getMoreResults=function(){if(typeof t.moreResults==="function"){t.moreResults(t.searchStr)}};t.selectResult=function(e){if(ut(t.results[t.currentIndex])){if(t.matchClass){e.title=F(e.originalObject);e.description=I(e.originalObject,t.descriptionField)}if(t.clearSelected){t.searchStr=null}else{t.searchStr=e.title}H(e);tt()}};t.inputChangeHandler=function(e){if(e.length<S){tt()}if(t.inputChanged){e=t.inputChanged(e)}return e};if(t.fieldRequiredClass&&t.fieldRequiredClass!==""){N=t.fieldRequiredClass}if(t.minlength&&t.minlength!==""){S=t.minlength}if(!t.pause){t.pause=m}if(!t.clearSelected){t.clearSelected=false}if(!t.overrideSuggestions){t.overrideSuggestions=false}if(t.fieldRequired&&p){if(t.initialValue){R(true)}else{R(false)}}t.textSearching=h.textSearching||b;t.textNoResults=h.textNoResults||w;t.$watch(function(){return h.textSearching},function(e,n){t.textSearching=e||b});t.$watch(function(){return h.textNoResults},function(e,n){t.textNoResults=e||w});E.on("keydown",Q);E.on("keyup",U);C=B("remoteUrlResponseFormatter");t.$on("$destroy",function(){R(true)});i(function(){var e=getComputedStyle(A);O=e.maxHeight&&e.overflowY==="auto"})}}}])
