/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";!function(e,t){"undefined"!=typeof module&&module.exports?module.exports=t(require("angular")):"function"==typeof define&&define.amd?define(["angular"],t):t(e.angular)}(window,function(e){e.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate",function(e,t,n,r,l,s,o){function i(t,s,o,i){function I(e){pt=null,t.hideResults(e),document.body.removeEventListener("click",I)}function R(e){return e.which?e.which:e.keyCode}function C(e){"function"==typeof t.selectedObject?t.selectedObject(e):t.selectedObject=e,j(e?!0:!1)}function b(e){return function(n){return t[e]?t[e](n):n}}function $(e){C({originalObject:e}),t.clearSelected&&(t.searchStr=null),Y()}function D(e){return t.titleField.split(",").map(function(t){return F(e,t)}).join(" ")}function F(e,t){var n,r;if(t){n=t.split("."),r=e;for(var l=0;l<n.length;l++)r=r[n[l]]}else r=e;return r}function O(e,n){var l,s,o;return o=new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),e?(e.match&&e.replace||(e=e.toString()),s=e.match(o),l=s?e.replace(o,'<span class="'+t.matchClass+'">'+s[0]+"</span>"):e,r.trustAsHtml(l)):void 0}function j(e){t.notEmpty=e,at=t.searchStr,t.fieldRequired&&i&&i.$setValidity(ct,e)}function q(e){var n=R(e);if(n!==d&&n!==a)if(n===u||n===p)e.preventDefault();else if(n===c)e.preventDefault(),!t.showDropdown&&t.searchStr&&t.searchStr.length>=ot&&(G(),t.searching=!0,P(t.searchStr));else if(n===g)Y(),t.$apply(function(){st.val(t.searchStr)});else{if(0===ot&&!t.searchStr)return;t.searchStr&&""!==t.searchStr?t.searchStr.length>=ot&&(G(),it&&l.cancel(it),t.searching=!0,it=l(function(){P(t.searchStr)},t.pause)):t.showDropdown=!1,at&&at!==t.searchStr&&!t.clearSelected&&t.$apply(function(){C()})}}function U(e){!t.overrideSuggestions||t.selectedObject&&t.selectedObject.originalObject===t.searchStr||(e&&e.preventDefault(),$(t.searchStr))}function H(e){var t=getComputedStyle(e);return e.offsetHeight+parseInt(t.marginTop,10)+parseInt(t.marginBottom,10)}function k(){return dt.getBoundingClientRect().top+parseInt(getComputedStyle(dt).maxHeight,10)}function A(){return s[0].querySelectorAll(".angucomplete-row")[t.currentIndex]}function N(){return A().getBoundingClientRect().top-(dt.getBoundingClientRect().top+parseInt(getComputedStyle(dt).paddingTop,10))}function E(e){dt.scrollTop=dt.scrollTop+e}function T(){var e=t.results[t.currentIndex];st.val(t.matchClass?D(e.originalObject):e.title)}function L(e){var n=R(e),r=null,l=null;n===p&&t.results?(t.currentIndex>=0&&t.currentIndex<t.results.length?(e.preventDefault(),t.selectResult(t.results[t.currentIndex])):(U(e),Y()),t.$apply()):n===c&&t.results?(e.preventDefault(),t.currentIndex+1<t.results.length&&t.showDropdown&&(t.$apply(function(){if(!ft(t.results[t.currentIndex+1]))for(;t.currentIndex+1<t.results.length&&!ft(t.results[t.currentIndex+1]);)t.currentIndex++;t.currentIndex++,ft(t.results[t.currentIndex])&&T()}),gt&&(r=A(),k()<r.getBoundingClientRect().bottom&&E(H(r))))):n===u&&t.results?(e.preventDefault(),t.currentIndex>=1?(t.$apply(function(){if(t.currentIndex--,!ft(t.results[t.currentIndex-1]))for(;t.currentIndex>=1&&!ft(t.results[t.currentIndex-1]);)t.currentIndex--;t.currentIndex--,ft(t.results[t.currentIndex])&&T()}),gt&&(l=N(),0>l&&E(l-1))):0===t.currentIndex&&t.$apply(function(){t.currentIndex=-1,st.val(t.searchStr)})):n===h&&(t.results&&t.results.length>0&&t.showDropdown?-1===t.currentIndex&&t.overrideSuggestions?U():(-1===t.currentIndex&&(t.currentIndex=0),t.selectResult(t.results[t.currentIndex]),t.$digest()):t.searchStr&&t.searchStr.length>0&&U())}function B(e){return function(n,r,l,s){r||l||s||(n=n.data),t.searching=!1,X(F(tt(n),t.remoteUrlDataField),e)}}function V(e,n,r,l){n||r||l||(n=e.status),0!==n&&(t.remoteUrlErrorCallback?t.remoteUrlErrorCallback(e,n,r,l):console&&console.error&&console.error("http error"))}function M(){ut&&ut.resolve()}function W(r){var l={},s=t.remoteUrl+encodeURIComponent(r);t.remoteUrlRequestFormatter&&(l={params:t.remoteUrlRequestFormatter(r)},s=t.remoteUrl),t.remoteUrlRequestWithCredentials&&(l.withCredentials=!0),M(),ut=e.defer(),l.timeout=ut.promise,n.get(s,l).success(B(r)).error(V)}function z(n){M(),ut=e.defer(),t.remoteApiHandler(n,ut.promise).then(B(n)).catch(V)}function Y(){t.showDropdown=!1,t.results=[],dt&&(dt.scrollTop=0)}function G(){t.showDropdown=rt,t.currentIndex=-1,t.results=[]}function J(e){var n,r,l,s,o=t.searchFields.split(","),i=[];for(n=0;n<t.localData.length;n++){for(r=!1,l=0;l<o.length;l++)s=F(t.localData[n],o[l])||"",r=r||s.toString().toLowerCase().indexOf(e.toString().toLowerCase())>=0;r&&(i[i.length]=t.localData[n])}t.searching=!1,X(i,e)}function K(e,n,r){if(r)for(var l in n)if(n[l].toLowerCase()===r.toLowerCase())return void t.selectResult(e)}function P(e){!e||e.length<ot||(t.localData?t.$apply(function(){J(e)}):t.remoteApiHandler?z(e):W(e))}function Q(e,n,r){var l,s,o,i,c;t.titleField&&""!==t.titleField&&(o=i=D(e)),l="",t.descriptionField&&(l=c=F(e,t.descriptionField)),s="",t.imageField&&(s=F(e,t.imageField)),t.matchClass&&(i=O(o,n),c=O(l,n)),t.results[t.results.length]={title:i,description:c,image:s,originalObject:e},r&&(t.results[t.results.length-1].group_title=r),t.autoMatch&&K(t.results[t.results.length-1],{title:o,desc:l||""},t.searchStr)}function X(e,n){var r,l,s,o,i;if(e&&e.length>0){if(t.results=[],ht(e)&&e.length>0)for(r=0,s=e.length;s>r;r++)Q(e[r],n);else if(ft(e))for(i=mt(e),r=0,s=i.length;s>r;r++)if(o=e[i[r]].length,o>0)for(t.results[t.results.length]=i[r],l=0;o>l;l++)Q(e[i[r]][l],n,i[r])}else t.results=[];t.showDropdown=!(0===t.results.length&&!lt)}function Z(){t.localData?X(t.localData,""):t.remoteApiHandler?z(""):W("")}var et,tt,nt,rt,lt,st=s.find("input"),ot=f,it=null,ct=x,at=null,ut=null,dt=s[0].querySelector(".angucomplete-dropdown"),gt=!1,pt=null;s.on("mousedown",function(e){e.target.id?(pt=e.target.id,pt===t.id+"_dropdown"&&document.body.addEventListener("click",I)):pt=e.target.className}),t.currentIndex=null,t.searching=!1,nt=t.$watch("initialValue",function(e){e&&(nt(),"object"==typeof e?(t.searchStr=D(e),C({originalObject:e})):"string"==typeof e&&e.length>0?t.searchStr=e:console&&console.error&&console.error("Tried to set initial value of angucomplete to",e,"which is an invalid value"),j(!0))}),t.$on("angucomplete-alt:clearInput",function(e,n){n&&n!==t.id||(t.searchStr=null,C(),j(!1),Y())});var ht=Array.isArray||function(e){return"[object Array]"===toString.call(e)},ft=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},mt=function(e){if(!ft(e))return[];if(Object.keys)return Object.keys(e);var t=[];for(var n in e)_.has(e,n)&&t.push(n);return t};t.onFocusHandler=function(){t.focusIn&&t.focusIn(),0!==ot||t.searchStr&&0!==t.searchStr.length||(t.showDropdown=!0,Z())},t.hideResults=function(){pt&&(pt===t.id+"_dropdown"||pt.indexOf("angucomplete")>=0)?pt=null:(et=l(function(){Y(),t.$apply(function(){t.searchStr&&t.searchStr.length>0&&st.val(t.searchStr)})},S),M(),t.focusOut&&t.focusOut(),t.overrideSuggestions&&t.searchStr&&t.searchStr.length>0&&-1===t.currentIndex&&U())},t.resetHideResults=function(){et&&l.cancel(et)},t.hoverRow=function(e){t.currentIndex=e},t.getMoreResults=function(){"function"==typeof t.moreResults&&t.moreResults(t.searchStr)},t.selectResult=function(e){ft(t.results[t.currentIndex])&&(t.matchClass&&(e.title=D(e.originalObject),e.description=F(e.originalObject,t.descriptionField)),t.searchStr=t.clearSelected?null:e.title,C(e),Y())},t.inputChangeHandler=function(e){return e.length<ot?Y():0===e.length&&0===ot&&(t.searching=!1,Z()),t.inputChanged&&(e=t.inputChanged(e)),e},t.fieldRequiredClass&&""!==t.fieldRequiredClass&&(ct=t.fieldRequiredClass),t.minlength&&""!==t.minlength&&(ot=parseInt(t.minlength,10)),t.pause||(t.pause=v),t.clearSelected||(t.clearSelected=!1),t.overrideSuggestions||(t.overrideSuggestions=!1),t.fieldRequired&&i&&j(t.initialValue?!0:!1),t.inputType=o.type?o.type:"text",t.textSearching=o.textSearching?o.textSearching:w,t.textNoResults=o.textNoResults?o.textNoResults:y,rt="false"!==t.textSearching,lt="false"!==t.textNoResults,t.$watch(function(){return o.textSearching},function(e){t.textSearching=e||w}),t.$watch(function(){return o.textNoResults},function(e){t.textNoResults=e||y}),t.maxlength=o.maxlength?o.maxlength:m,st.on("keydown",L),st.on("keyup",q),tt=b("remoteUrlResponseFormatter"),t.$on("$destroy",function(){j(!0)}),l(function(){var e=getComputedStyle(dt);gt=e.maxHeight&&"auto"===e.overflowY})}var c=40,a=39,u=38,d=37,g=27,p=13,h=9,f=3,m=524288,v=500,S=200,x="autocomplete-required",w="Searching...",y="No results found",I="/angucomplete-alt/index.html";return s.put(I,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">  <input id="{{id}}_value" name="{{inputName}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)"/>  <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">    <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>    <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>    <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">      <div ng-if="imageField" class="angucomplete-image-holder">        <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/>        <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>      </div>      <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>      <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>      <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>      <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>    </div>  </div></div>'),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",moreResults:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",inputName:"@"},templateUrl:function(e,t){return t.templateUrl||I},compile:function(e){var t=o.startSymbol(),n=o.endSymbol();if("{{"!==t||"}}"!==n){var r=e.html().replace(/\{\{/g,t).replace(/\}\}/g,n);e.html(r)}return i}}}])});
